name: GSC Data Fetcher

on: []
  # Run daily at 6 AM UTC (adjust timezone as needed)
  schedule:
    - cron: '0 6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation mode'
        required: true
        default: 'daily'
        type: choice
        options:
          - daily
          - historical
          - test
          - summary
      months:
        description: 'Months back for historical fetch'
        required: false
        default: '16'
      days:
        description: 'Days back for daily fetch'
        required: false
        default: '7'

jobs:
  fetch-gsc-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create service account file
      run: |
        echo '${{ secrets.GSC_SERVICE_ACCOUNT_JSON }}' > service_account.json
    
    - name: Run GSC data fetch
      env:
        SERVICE_ACCOUNT_FILE: './service_account.json'
        SITE_URL: ${{ secrets.SITE_URL }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        USE_REST_API: "true"  # Changed to true to avoid PostgreSQL connection issues
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          python main.py --mode ${{ github.event.inputs.mode }} --months ${{ github.event.inputs.months }} --days ${{ github.event.inputs.days }}
        else
          python main.py --mode daily
        fi
    
    - name: Clean up service account file
      if: always()
      run: |
        rm -f service_account.json
    
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}  # Added explicit token
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'GSC Data Fetch Failed',
            body: `The GSC data fetch workflow failed on ${new Date().toISOString()}. Please check the logs for details.`,
            labels: ['bug', 'automation']
          })

  # Optional: Weekly summary job
  weekly-summary:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 6 * * 1' # Monday at 6 AM
    needs: fetch-gsc-data
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create service account file
      run: |
        echo '${{ secrets.GSC_SERVICE_ACCOUNT_JSON }}' > service_account.json
    
    - name: Generate weekly summary
      env:
        SERVICE_ACCOUNT_FILE: './service_account.json'
        SITE_URL: ${{ secrets.SITE_URL }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        USE_REST_API: "true"
      run: |
        python main.py --mode summary
    
    - name: Clean up
      if: always()
      run: |
        rm -f service_account.json